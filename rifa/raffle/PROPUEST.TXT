ocumento de especificación técnica
ESPECIFICACIÓN TÉCNICA - SISTEMA DE RIFAS
1. REGLAS DE NEGOCIO
1.1. Reglas de visibilidad de información
RN-001: Información pública visible
El usuario puede ver: título del sorteo, descripción, imagen del premio, precio del boleto
El usuario no puede ver: total de boletos disponibles, total recaudado, boletos vendidos, fecha del sorteo
RN-002: Información del boleto
El número de boleto se asigna automáticamente al confirmar el pago
El usuario no puede seleccionar el número de boleto
La asignación es secuencial (1, 2, 3... hasta 60,000)
RN-003: Notificación de boleto
Al confirmar el pago, el usuario recibe su número de boleto por:
Email
WhatsApp
El número se envía automáticamente después de la confirmación del pago
1.2. Reglas de autenticación
RN-004: Login opcional
El usuario puede comprar sin iniciar sesión
Si compra sin login: solo recibe número por WhatsApp/Email
Si compra con login: puede ver sus números en "Mis Boletos"
RN-005: Visualización de boletos
Usuario logueado antes de comprar: puede ver sus números después de la compra
Usuario sin login: no puede ver sus números después (solo en notificaciones)
1.3. Reglas de compra
RN-006: Compra de boletos
El usuario puede comprar 1 o más boletos en una sola transacción
Cada boleto tiene el mismo precio (ej: $1.00)
El total se calcula: cantidad de boletos × precio unitario
RN-007: Asignación de boletos
Los boletos se asignan automáticamente al confirmar el pago
Se asigna el siguiente número disponible en orden secuencial
Si compra múltiples boletos, se asignan números consecutivos
RN-008: Disponibilidad de boletos
Un boleto solo puede ser vendido una vez
No se pueden vender más de 60,000 boletos por sorteo
Si no hay boletos disponibles, se muestra mensaje de error
1.4. Reglas de pago
RN-009: Pasarela de pago
Se utiliza Payphone como pasarela de pago
El pago debe confirmarse antes de asignar el boleto
Si el pago falla, no se asigna boleto
RN-010: Estados de pago
pending: pago iniciado, esperando confirmación
completed: pago confirmado, boleto asignado
failed: pago fallido, no se asigna boleto
2. REQUISITOS FUNCIONALES
2.1. Gestión de sorteos
RF-001: Visualización de sorteo
El sistema debe mostrar la página de detalle del sorteo con:
Título
Descripción
Imagen del premio
Precio del boleto
Botón "Comprar Boleto"
No debe mostrar: fecha del sorteo, total recaudado, total de boletos, boletos vendidos
RF-002: Listado de sorteos
El sistema debe mostrar una lista de sorteos activos
Cada sorteo muestra: título, imagen del premio, precio del boleto
No muestra información secreta
2.2. Gestión de compras
RF-003: Proceso de compra
El sistema debe permitir al usuario:
Ver el sorteo
Hacer clic en "Comprar Boleto"
Llenar formulario (nombre, email, teléfono)
Seleccionar cantidad de boletos (opcional, mínimo 1)
Ver total a pagar
Redirigir a Payphone para pago
RF-004: Asignación automática de boletos
Al confirmar el pago, el sistema debe:
Asignar número(s) de boleto automáticamente
Marcar boleto(s) como vendido(s)
Actualizar estadísticas del sorteo
Enviar notificaciones (Email y WhatsApp)
RF-005: Validación de disponibilidad
Antes de procesar el pago, el sistema debe verificar que haya boletos disponibles
Si no hay boletos disponibles, debe mostrar error y no permitir la compra
2.3. Gestión de usuarios
RF-006: Autenticación opcional
El sistema debe permitir registro/login de usuarios
El login no es obligatorio para comprar
Si el usuario está logueado, puede ver sus boletos en "Mis Boletos"
RF-007: Visualización de boletos propios
Usuario logueado puede acceder a "Mis Boletos"
Debe mostrar: número de boleto, sorteo, fecha de compra, estado de pago
Solo muestra boletos con pago confirmado
2.4. Notificaciones
RF-008: Envío de Email
Al confirmar el pago, el sistema debe enviar email con:
Número(s) de boleto asignado(s)
Información del sorteo
Mensaje de confirmación
RF-009: Envío de WhatsApp
Al confirmar el pago, el sistema debe enviar mensaje de WhatsApp con:
Número(s) de boleto asignado(s)
Información del sorteo
Mensaje de confirmación
2.5. Integración con Payphone
RF-010: Procesamiento de pago
El sistema debe integrarse con Payphone para:
Crear sesión de pago
Redirigir al usuario a Payphone
Recibir confirmación de pago vía webhook
Actualizar estado de la venta
RF-011: Webhook de Payphone
El sistema debe tener endpoint para recibir webhooks de Payphone
Al recibir confirmación de pago, debe:
Validar la transacción
Asignar boleto(s)
Enviar notificaciones
Actualizar estadísticas
3. CASOS DE USO
CU-001: Usuario compra boleto sin login
Actor: Usuario anónimo
Precondiciones:
Existe un sorteo activo
Hay boletos disponibles
Flujo principal:
Usuario accede a la página del sorteo
Usuario ve: título, descripción, imagen, precio del boleto
Usuario hace clic en "Comprar Boleto"
Sistema muestra formulario de checkout
Usuario llena: nombre, email, teléfono
Usuario selecciona cantidad de boletos (opcional)
Usuario confirma compra
Sistema redirige a Payphone
Usuario completa pago en Payphone
Payphone confirma pago vía webhook
Sistema asigna número(s) de boleto automáticamente
Sistema envía Email y WhatsApp con número(s) de boleto
Usuario recibe notificaciones
Postcondiciones:
Boleto(s) asignado(s) y marcado(s) como vendido(s)
Usuario recibió notificaciones con su número de boleto
Usuario no puede ver sus boletos después (no tiene cuenta)
CU-002: Usuario logueado compra boleto
Actor: Usuario autenticado
Precondiciones:
Usuario tiene cuenta y está logueado
Existe un sorteo activo
Hay boletos disponibles
Flujo principal:
Usuario accede a la página del sorteo (logueado)
Usuario ve información del sorteo
Usuario hace clic en "Comprar Boleto"
Sistema muestra formulario (pre-llenado con datos del usuario)
Usuario confirma compra
Sistema redirige a Payphone
Usuario completa pago
Payphone confirma pago vía webhook
Sistema asigna número(s) de boleto
Sistema envía notificaciones
Usuario puede ver sus boletos en "Mis Boletos"
Postcondiciones:
Boleto(s) asignado(s)
Usuario recibió notificaciones
Usuario puede ver sus boletos en "Mis Boletos"
CU-003: Usuario logueado ve sus boletos
Actor: Usuario autenticado
Precondiciones:
Usuario tiene cuenta y está logueado
Usuario tiene al menos una compra confirmada
Flujo principal:
Usuario accede a "Mis Boletos"
Sistema muestra lista de boletos del usuario
Para cada boleto muestra: número, sorteo, fecha de compra
Usuario puede ver detalles de cada boleto
Postcondiciones:
Usuario visualiza todos sus boletos con pago confirmado
CU-004: Sistema asigna boleto automáticamente
Actor: Sistema
Precondiciones:
Pago confirmado por Payphone
Hay boletos disponibles
Flujo principal:
Sistema recibe webhook de Payphone con pago confirmado
Sistema valida la transacción
Sistema busca siguiente número de boleto disponible
Sistema asigna número(s) de boleto (secuencial)
Sistema marca boleto(s) como vendido(s)
Sistema actualiza estadísticas del sorteo
Sistema envía notificaciones
Postcondiciones:
Boleto(s) asignado(s) y marcado(s) como vendido(s)
Estadísticas actualizadas
Notificaciones enviadas
CU-005: Usuario intenta comprar sin boletos disponibles
Actor: Usuario (logueado o anónimo)
Precondiciones:
No hay boletos disponibles (60,000 vendidos)
Flujo principal:
Usuario intenta comprar boleto
Sistema verifica disponibilidad
Sistema detecta que no hay boletos disponibles
Sistema muestra mensaje: "No hay boletos disponibles"
Sistema no permite proceder con el pago
Postcondiciones:
No se procesa la compra
Usuario ve mensaje de error
4. FLUJOS DEL SISTEMA
4.1. Flujo de compra (sin login)
┌─────────────┐│   Usuario   │└──────┬──────┘       │       ▼┌─────────────────────┐│ Ve página sorteo    ││ - Título            ││ - Descripción       ││ - Imagen premio     ││ - Precio: $1        ││ (NO ve: fecha,      ││  total, boletos)    │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Click "Comprar"     │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Formulario Checkout ││ - Nombre            ││ - Email             ││ - Teléfono          ││ - Cantidad (opc)    │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Redirige Payphone  │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Usuario paga        │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Payphone Webhook    ││ (pago confirmado)   │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Sistema asigna      ││ boleto automático   ││ (ej: #12345)        │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Envía notificaciones││ - Email             ││ - WhatsApp          │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Usuario recibe      ││ número de boleto    │└─────────────────────┘
4.2. Flujo de compra (con login)
┌─────────────┐│ Usuario     ││ (logueado)  │└──────┬──────┘       │       ▼┌─────────────────────┐│ Ve página sorteo    │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Click "Comprar"     │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Formulario          ││ (pre-llenado)       │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Paga en Payphone    │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Boleto asignado    ││ + Notificaciones    │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Puede ver en        ││ "Mis Boletos"       │└─────────────────────┘
4.3. Flujo de asignación automática
┌─────────────────────┐│ Webhook Payphone     ││ (pago confirmado)    │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Validar transacción │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Buscar siguiente    ││ boleto disponible    ││ (ej: #12345)        │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Asignar boleto      ││ - Marcar como sold  ││ - Guardar en sale   │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Actualizar stats    ││ - tickets_sold++     ││ - total_revenue+=   │└──────┬──────────────┘       │       ▼┌─────────────────────┐│ Enviar notificaciones││ - Email             ││ - WhatsApp          │└─────────────────────┘
5. MODELO DE DATOS
5.1. Entidades principales
raffles (Sorteos)
id, title, description, prize_image_url, prize_name
total_tickets (60,000) - SECRETO
price_per_ticket - PÚBLICO
total_revenue - SECRETO
tickets_sold - SECRETO
status, created_at, updated_at
tickets (Boletos)
id, raffle_id, ticket_number (1-60,000)
status ('available', 'sold')
sale_id
customers (Clientes)
id, name, email, phone
user_id (opcional, si tiene cuenta)
sales (Ventas)
id, raffle_id, customer_id
ticket_number (asignado automáticamente)
amount, payment_status, payment_id
email_sent, whatsapp_sent
users (Usuarios)
id, email, phone, name
auth_user_id (Supabase Auth)
6. INTERFACES DE USUARIO
6.1. Página de Sorteo
Elementos visibles:
Título del sorteo
Imagen del premio
Descripción
Precio del boleto: "$1.00"
Botón "Comprar Boleto"
Elementos NO visibles:
Fecha del sorteo
Total recaudado
Total de boletos
Boletos vendidos
6.2. Página de Checkout
Elementos:
Formulario: Nombre, Email, Teléfono
Cantidad de boletos (opcional, default: 1)
Total a pagar
Botón "Pagar con Payphone"
6.3. Página "Mis Boletos" (solo logueados)
Elementos:
Lista de boletos del usuario
Para cada boleto: número, sorteo, fecha de compra
7. INTEGRACIONES
7.1. Payphone
Crear sesión de pago
Redirigir usuario
Recibir webhook de confirmación
7.2. Email (Resend)
Enviar confirmación con número de boleto
7.3. WhatsApp (Twilio/WhatsApp Business API)
Enviar mensaje con número de boleto
8. SEGURIDAD
8.1. Protección de información
Row Level Security (RLS) en Supabase
Vista pública que oculta campos secretos
Validación de permisos en backend
8.2. Validaciones
Verificar disponibilidad antes de asignar
Validar webhook de Payphone
Prevenir asignación duplicada de boletos
9. CRITERIOS DE ACEPTACIÓN
CA-001: Compra sin login
Usuario puede comprar sin cuenta
Recibe número por Email y WhatsApp
No puede ver sus boletos después
CA-002: Compra con login
Usuario logueado puede comprar
Puede ver sus boletos en "Mis Boletos"
Recibe notificaciones
CA-003: Asignación automática
Boleto se asigna automáticamente
Números son secuenciales
No se asignan números duplicados
CA-004: Información oculta
No se muestra fecha del sorteo
No se muestra total recaudado
No se muestra total de boletos
